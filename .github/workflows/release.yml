name: Production Release Build

# ==============================================================================
# TRIGGER CONFIGURATION
# ==============================================================================
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# ==============================================================================
# GLOBAL PERMISSIONS
# ==============================================================================
permissions:
  contents: write

jobs:
  # ----------------------------------------------------------------------------
  # PACKAGE & PUBLISH JOB
  # Because PHP is interpreted, we don't need a compilation matrix.
  # We just need to bundle the raw source files, stripping out development tools.
  # ----------------------------------------------------------------------------
  release:
    name: Package and Publish Release
    runs-on: ubuntu-latest
    # Acts as a strict safety net: prevents automated releases for manual workflow runs on non-tag branches.
    if: startsWith(github.ref, 'refs/tags/')
    
    # We declare the variable here to satisfy static YAML linters (like VS Code).
    # It will be dynamically overwritten by the build step below.
    env:
      ARCHIVE_NAME: ''
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 

      - name: Prepare Production Artifact
        shell: bash
        run: |
          echo "=> Identifying release version..."
          VERSION=${GITHUB_REF#refs/tags/}
          ARCHIVE_NAME="php-birthday-${VERSION}.zip"
          
          echo "=> Creating an isolated staging directory..."
          mkdir staging
          
          echo "=> Copying production files (excluding Dev/Test assets)..."
          # We copy the root directory but strictly EXCLUDE dev dependencies, 
          # git files, and the staging folder itself to prevent recursion.
          rsync -av --progress ./ staging/ \
            --exclude='staging/' \
            --exclude='.git*' \
            --exclude='.github/' \
            --exclude='tests/' \
            --exclude='vendor/' \
            --exclude='.php-env/' \
            --exclude='.vscode/' \
            --exclude='scripts/' \
            --exclude='phpunit.xml' \
            --exclude='composer.*' \
            --exclude='.editorconfig'
          
          echo "=> Building final zip archive..."
          cd staging
          zip -r ../${ARCHIVE_NAME} .
          cd ..
          
          echo "=> Exposing archive name to subsequent steps..."
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV

      - name: Instantiate GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Target the zip file we just created
          files: ${{ env.ARCHIVE_NAME }}
          # Automatically generates release notes based on Pull Requests and commits
          generate_release_notes: true
          draft: false
          prerelease: false
